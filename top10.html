<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TCD â€” Top 10</title>

  <style>
  /* -------- Base (tweak via URL params) -------- */
  :root{
    --bar-h:32px;       /* height via ?h= */
    --bg:#f5f7fa;       /* background via ?bg= */
    --fg:#000000;       /* text color via ?fg= */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font:600 16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    overflow:hidden;
    white-space:nowrap;
  }
  /* wrapper */
  .wrap{
    height:var(--bar-h);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
  }
  /* the line with the teams */
  ol{
    display:flex;
    list-style:none;
    padding:0;
    margin:0;
    width:100%;
    align-items:baseline;
    justify-content:space-between;   /* stretches full width */
    gap:22px;                        /* tiny breathing room */
    font-size:clamp(12px, calc((var(--bar-h) - 10px)), 22px);
  }
  /* rank + team chunk */
  li{display:flex; gap:.35em; align-items:baseline}
  .rk{opacity:.85}
  .team{font-weight:700}

  /* -------- LSU special: purple text with gold outline on each letter -------- */
  [data-team="LSU"]{
    color:#3D2173; /* LSU purple fill */
    -webkit-text-stroke:1px #FDBB30; /* gold edge (WebKit) */
    text-shadow:
      0  1px 0 #FDBB30, 0 -1px 0 #FDBB30,
      1px 0  0 #FDBB30, -1px 0 0 #FDBB30; /* gold edge fallback */
    letter-spacing:.03em; /* tiny separation between letters */
  }
  </style>
</head>
<body>
  <div class="wrap">
    <ol id="line" aria-label="Top teams"></ol>
  </div>

  <script>
  /* ---- read URL params ---- */
  const qp   = new URLSearchParams(location.search);
  const poll = (qp.get('poll') || 'ap').toLowerCase();   // "ap" | "coaches"
  const n    = Math.max(1, +(qp.get('n') || 10));
  const h    = +(qp.get('h') || 32);
  const bg   = '#' + (qp.get('bg') || 'f5f7fa').replace('#','');
  const fg   = '#' + (qp.get('fg') || '000000').replace('#','');

  document.documentElement.style.setProperty('--bar-h', h + 'px');
  document.documentElement.style.setProperty('--bg', bg);
  document.documentElement.style.setProperty('--fg', fg);

  /* ---- team color map (fill color; LSU outline is in CSS) ---- */
  const TEAM_COLORS = {
    'Texas':      '#BF5700',
    'Penn State': '#162952',
    'Ohio State': '#BB0000',
    'Clemson':    '#F56600',
    'Georgia':    '#BA0C2F',
    'Notre Dame': '#0C2340',
    'Oregon':     '#154733',
    'Alabama':    '#9E1B32',
    'LSU':        '#3D2173',  // outline handled by CSS
    'Miami':      '#F47321',
  };

  const byId = id => document.getElementById(id);

  function pickTeamName(row){
    return (row.team || row.Team || row.school || row.School || row.name || row.Name || '').trim();
  }

  /* Accepts many shapes and returns [{rank, team}, ...] */
  function normalizeArray(data){
    if (Array.isArray(data)) {
      return data.map(r => ({
        rank: (+r.rank || +r.Rank || +r.position || +r.Position || 0),
        team: pickTeamName(r)
      }));
    }
    if (data && Array.isArray(data.teams)) {
      return data.teams.map(r => ({
        rank: (+r.rank || +r.Rank || +r.position || +r.Position || 0),
        team: pickTeamName(r)
      }));
    }
    if (data && Array.isArray(data.ranks)) {
      return data.ranks.map(r => ({
        rank: (+r.rank || +r.Rank || +r.position || +r.Position || 0),
        team: pickTeamName(r)
      }));
    }
    return [];
  }

  function colorFor(team){
    return TEAM_COLORS[team] || 'var(--fg)';
  }

  function render(list){
    const line = byId('line');
    line.innerHTML = '';
    list.slice(0, n).forEach(row => {
      const li = document.createElement('li');

      const rk = document.createElement('span');
      rk.className = 'rk';
      rk.textContent = `${row.rank}.`;

      const tm = document.createElement('span');
      tm.className = 'team';
      tm.dataset.team = row.team;     // enables LSU special
      tm.textContent = row.team;
      tm.style.color = colorFor(row.team);

      li.append(rk, tm);
      line.append(li);
    });
  }

  async function resolveDataUrl(){
    // if iframe explicitly passed a URL, honor it
    const apUrlParam       = qp.get('apUrl');
    const coachesUrlParam  = qp.get('coachesUrl');
    if (apUrlParam || coachesUrlParam) {
      return poll === 'ap' ? apUrlParam : coachesUrlParam;
    }
    // otherwise ask our API for the freshest blobs, with local fallback
    try {
      const resp = await fetch('/api/update', { cache:'no-store' });
      const j = await resp.json();
      return poll === 'ap' ? (j.apUrl || '/tcd-ap.json') : (j.coachesUrl || '/tcd-coaches.json');
    } catch {
      return poll === 'ap' ? '/tcd-ap.json' : '/tcd-coaches.json';
    }
  }

  /* ---- fetch & render ---- */
  resolveDataUrl()
    .then(url => fetch(url, { cache:'no-store' }).then(r => r.json()))
    .then(json => {
      let rows = normalizeArray(json)
        .filter(x => (x.rank > 0) && x.team)
        .sort((a,b) => a.rank - b.rank);
      if (!rows.length) throw new Error('No rows');
      render(rows);
    })
    .catch(err => {
      byId('line').innerHTML = '<li><span class="team">Unable to load rankings.</span></li>';
      console.error('top10 load error:', err);
    });
  </script>
</body>
</html>
