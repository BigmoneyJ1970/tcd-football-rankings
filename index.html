<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TCD Football Rankings</title>
  <style>
    :root { --card:#fff; --line:#e5e7eb; --ink:#111827; --muted:#6b7280; --bg:#f8fafc; }
    *{box-sizing:border-box}
    body{margin:0;font:16px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:24px;margin:0 0 12px}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:0 0 16px}
    button{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    button:hover{background:#f3f4f6}
    .grids{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){ .grids{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:#f9fafb}
    .title{font-weight:600}
    .meta{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #f1f5f9}
    th{font-size:12px;text-transform:uppercase;color:var(--muted);letter-spacing:.03em;text-align:left}
    td.rank{width:42px;text-align:right;font-variant-numeric:tabular-nums;color:#64748b}
    td.rec{font-variant-numeric:tabular-nums;color:#374151}
    .err{padding:12px;color:#b91c1c}
    .links{font-size:12px;color:var(--muted)}
    .links a{color:inherit}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TCD Football Rankings</h1>

    <div class="bar">
      <button id="btn-update" title="Call /api/update to refresh blobs">Update data</button>
      <button id="btn-reload" title="Only refetch from the existing blob URLs">Reload</button>
      <span class="links">
        JSON: <a id="apLink" href="#" target="_blank" rel="noopener">AP</a> ·
        <a id="coachesLink" href="#" target="_blank" rel="noopener">Coaches</a>
      </span>
    </div>

    <div class="grids">
      <div class="card" id="apCard">
        <div class="head">
          <div class="title">AP Top 25</div>
          <div class="meta" id="apMeta">—</div>
        </div>
        <div id="apBody"></div>
      </div>

      <div class="card" id="coachesCard">
        <div class="head">
          <div class="title">Coaches Top 25</div>
          <div class="meta" id="coachesMeta">—</div>
        </div>
        <div id="coachesBody"></div>
      </div>
    </div>
  </div>

  <script>
    // Using the blob URLs from /api/update
    let AP_URL = "https://u5vu5e0xbo8k8p8i.public.blob.vercel-storage.com/tcd-ap.json";
    let COACHES_URL = "https://u5vu5e0xbo8k8p8i.public.blob.vercel-storage.com/tcd-coaches.json";

    const apLink = document.getElementById('apLink');
    const coachesLink = document.getElementById('coachesLink');
    apLink.href = AP_URL;
    coachesLink.href = COACHES_URL;

    function renderTable(containerId, metaId, data){
      const body = document.getElementById(containerId);
      const meta = document.getElementById(metaId);

      if (!data || !Array.isArray(data.teams)) {
        body.innerHTML = `<div class="err">Could not load data.</div>`;
        meta.textContent = '—';
        return;
      }

      const when = data.lastUpdated ? new Date(data.lastUpdated) : null;
      meta.textContent = when ? `Updated ${when.toLocaleString()}` : '';

      const rows = data.teams.slice(0,25).map(t => `
        <tr>
          <td class="rank">${t.rk ?? ''}</td>
          <td>${t.team ?? ''}</td>
          <td class="rec">${t.rec ?? ''}</td>
          <td>${t.conf ?? ''}</td>
        </tr>
      `).join('');

      body.innerHTML = `
        <table>
          <thead>
            <tr><th>#</th><th>Team</th><th>Record</th><th>Conf</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    async function fetchJson(url){
      const r = await fetch(url, { cache:'no-cache' });
      if (!r.ok) throw new Error(`Fetch failed ${r.status}`);
      return r.json();
    }

    async function loadTables(){
      try {
        const [ap, coaches] = await Promise.all([
          fetchJson(AP_URL),
          fetchJson(COACHES_URL)
        ]);
        renderTable('apBody', 'apMeta', ap);
        renderTable('coachesBody', 'coachesMeta', coaches);
      } catch (e) {
        document.getElementById('apBody').innerHTML = `<div class="err">${e.message}</div>`;
        document.getElementById('coachesBody').innerHTML = `<div class="err">${e.message}</div>`;
      }
    }

    async function updateData(){
      const r = await fetch('/api/update', { cache:'no-cache' });
      const j = await r.json();
      if (j.apUrl)     { AP_URL = j.apUrl; apLink.href = AP_URL; }
      if (j.coachesUrl){ COACHES_URL = j.coachesUrl; coachesLink.href = COACHES_URL; }
      await loadTables();
    }

    document.getElementById('btn-reload').addEventListener('click', loadTables);
    document.getElementById('btn-update').addEventListener('click', updateData);

    // Initial load
    loadTables();
  </script>
</body>
</html>
